<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Hello World</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
</head>

<body>
<div class="app">
    <div id="deviceready" class="blink">
        <p class="event listening">Connecting to Device</p>
        <p class="event received">Device is Ready</p>
    </div>
</div>


<input type="text" id="m_id"  value="s001">
<input type="text" id="custom_name"  value="alex" >
<button type="button" onclick="existOwner()" >existOwner</button>
<button type="button" onclick="register()" >register</button>
<button type="button" onclick="delRegister()" >delRegister</button>
<button type="button" onclick="getContacts()" >getContacts</button>
<button type="button" onclick="unreadchat()" >unreadchat</button>
<button type="button" onclick="regGroup()" >regGroup</button>
<button type="button" onclick="delChatHistory()" >delChatHistory</button>

<BR>

<hr>
<button type="button" onclick="saveChatSettings()" >saveChatSettings</button>
<button type="button" onclick="getChatSettings()" >getChatSettings</button>
<button type="button" onclick="initConn()" >initConn</button>
<button type="button" onclick="disconnect()" >disconnect</button>

<hr>
channel:<input type="text" id="ichannel"  value="s002">
sid:<input type="text" id="isid"  value="s001">
tid:<input type="text" id="itid"  value="s002">
<button type="button" onclick="sendInvite()" >Invite</button>
<button type="button" onclick="secretInvite()" >secretInvite</button>

<BR>

<hr>
channel:<input type="text" id="xchannel"  value="">
<button type="button" onclick="subscribe()" >subscribe</button>
<button type="button" onclick="unsubscribe()" >unsubscribe</button>
<button type="button" onclick="send()" >send</button>
<button type="button" onclick="sendG()" >sendG</button>
<button type="button" onclick="querydbdate()" >querydbdate</button>
<button type="button" onclick="getDeviceID()" >getDeviceID</button>

<button type="button" onclick="undelivered()" >undelivered</button>
data:<input type="text" id="xmsg"  value="mymessage">
<button type="button" onclick="openrooms()" >openrooms</button>
<button type="button" onclick="closerooms()" >closerooms</button>
<button type="button" onclick="getOpenRooms()" >getOpenRooms</button>
<button type="button" onclick="getOnLineUsers()" >getOnLineUsers</button>
<button type="button" onclick="crudTsFlag()" >crudTsFlag</button>
<button type="button" onclick="crudNews()" >crudNews</button>
<button type="button" onclick="resetdb()" >resetdb</button>
<BR>

<button type="button" onclick="javascript:$('#message').empty()" >clear</button>


<div id="message"></div>

<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="js/index.js"></script>

<script>

   document.addEventListener("deviceready", onDeviceReady, false);
   function onDeviceReady() {
       window.addEventListener("wechatevent", OnEBusEvent, false);
   };

   //custom event  recived  message
   function OnEBusEvent( obj ){  //JSONObject
       //check
       console.log( obj );

       //do something here
       for (var i=0 ; i <  obj.data.length ; i++){
            $("#message").append("<p>" + obj.data[i].data  +"</p>");
       }

       alert("readed");

       //write sqlite and server are readed;
       //wechat.rereaded( obj );   //deprecated
   };


   //start reciever
   function start(){
      wechat.start();
   }

   //stop reciever
   function stop(){
      wechat.stop();
   }

   //sendBrodcast
   function sendBroadcast(msg){
       var obj = {data: msg};
       wechat.sendBroadcast(obj ,
           function(data){
               alert(data);
           },
           function(data){
               alert(data);
       });
   }

   //save
   function saveChatSettings(){
        var conf = { serverip: "serverip",
                    port: 3002,
                    notifyTarget: "tw.com.bais.wechat.MainActivity",
                    notifyTicker: "message",
                    notifyTitle: "",
                    hasVibrate: 1,
                    hasSound: 1,
                    hasSaveEl: 1 ,
                    key: "1234567890mobile" ,
                    fontSize: 12
                    };

        wechat.saveChatSettings( conf , function(err){
            alert("error");
        });
   }


   //getChatSettings
   function getChatSettings(){
        wechat.getChatSettings( function( data ){
            console.log( data );
        });
   }

   //init
   function initConn(){
        wechat.initConn();
   }

   //connect error msg
   function wechatOnConnectError(data){
        alert( data.msg );
   }


   //connnect
   //disconnect
   function disconnect(){
        wechat.disconnect();
   }

   //subscribe
   function subscribe(){
        var channMsg = { channel: $("#xchannel").val() , tid: $("#m_id").val() };
        wechat.subscribe( channMsg );
   }

   //unsubscribe
   function unsubscribe(){
       var channMsg = { channel: $("#xchannel").val() };
       wechat.unsubscribe( channMsg );
   }

   //send
   function send(){
        //var newchann =  wechat.getInviteChann($("#isid").val() , $("#itid").val()  )
        var pack = { device:"desktop|mobile", channel: $("#xchannel").val(),sid: $("#isid").val() ,tid: $("#itid").val() , action:"send",  category:"user" ,data:$("#xmsg").val() };
        wechat.send( pack );
   }

   //sendG
   function sendG(){
        var pack = { device:"desktop|mobile", channel: $("#xchannel").val(),sid: $("#isid").val(),tid: $("#itid").val(),gid:$("#xchannel").val(), action:"send",  category:"user" ,data:$("#xmsg").val()};
        wechat.send( pack );

        /*
        setInterval(function(){
            wechat.send( pack );
        },100);
        */
   }

   /*notify equipment
   function notify(){
        var pack = { channel: mydeviceid , device:"mobile", action:"notify", sid:"user00", tid: mydeviceid  ,category:"", data:"alex:john:what is this" };
        console.log(pack);
        wechat.notify( pack );
   }*/

   //querydbdate
   function querydbdate(){
        var pack = { channel:"s009@s001" ,offset:0, limit:10 };
        console.log(pack);
        wechat.querydbdate( pack , function(data){
            console.log( data );

        } , function(err){
            alert("eror");
        });
   }

   //deviceid
   function getDeviceID(){
        $("#message").append("<p>deviceid:" + wechat.deviceid  +"</p>");
   }

   function existOwner(){
        wechat.existOwner(function(data){
            var existowner = ( data == 1) ? true : false;
            $("#message").append("<p>hasOwner:" + existowner  +"</p>");
        });
   }

   //register
   function register(){
       //corps: -1 mobile_owner , action:"insert|update|delete|delallExcOwner"

       //var obj = { action: "insert" ,m_id: $("#m_id").val(), custom_name: $("#custom_name").val() , corps: -1 } ;
       var obj = { action: "insert" ,m_id: "s001", custom_name: 'alex' , corps: -1 , created_time:"1479959062300"} ;

       var obj2 = { action: "insert" ,m_id: "s002", custom_name:"xhsiung" , created_time:"1479959062500" } ;

       //console.log( obj );

       //reigiter(jobj , errorcallback)
       wechat.register( obj , function(){
            alert("error");
       });


       wechat.register( obj2 , function(){
            alert("error");
       });

   }

   function delRegister(){
       //action:"insert|update|delete|delall|delallExcOwner|delcorps"
       //var obj = { action: "update" ,m_id: $("#m_id").val(), custom_name: "aaaa" , corps: -1 } ;
       //var obj = { action: "delete" ,m_id: $("#m_id").val()} ;
       var obj = { action: "delcorps" , corps: 0 } ;

       console.log( obj );

       //reigiter(jobj , errorcallback)
       wechat.register( obj , function(){
            alert("error");
       });

   }

   //test
   function regGroup(){
        var obj = { action:"insert" , m_id: "g001", isgroup:1 , custom_name:"My家族" , created_time:"1479959062600"};
        wechat.register( obj , function(){
            alert("error");
        });


        var obj2 = { action:"insert" , m_id: "g002", isgroup:1 , custom_name:"My家族2" , created_time:"1479959062700"};
        wechat.register( obj2 , function(){
            alert("error");
        });

   }

   //sendInvite
   function sendInvite(){
        var newchann =  wechat.getInviteChann($("#isid").val() , $("#itid").val()  )

        var pack = {  device: "desktop|mobile" , channel:$("#ichannel").val() , sid: $("#isid").val() ,tid: $("#itid").val() , action:"invite", data: newchann  };
        console.log( pack );
        wechat.send( pack );

        var channMsg = { channel: newchann  };
        console.log( channMsg)
        wechat.subscribe( channMsg );
   }



   //contacts
   function getContacts(){
        //{} get all
        //{corps: -1}
        //{m_id: 's001'}
        var pack = {} ;
        wechat.getContacts( pack ,function(obj){
            console.log(obj);
            for (var i=0 ; i <  obj.data.length ; i++){
                $("#message").append("<p>m_id:" + obj.data[i].m_id + ",custom_name:"+  obj.data[i].custom_name +"</p>");
            }
        },function(){
            alert("error");
        });
   }


   //unreadchat
   function unreadchat(){
        wechat.unreadchat( function(data){
            console.log( data );
        });
   }


    function secretInvite(){
        //channel is tid , invite channel
        var pack = { sid : $("#isid").val() , tid: $("#itid").val() } ;
        wechat.secretInvite( pack );
    }

    function delChatHistory(){
        //var pack = { cid:"uxxxx12344543534534"} ;
        var pack = { channel:"s002@s001"} ;

        wechat.del_chat_history( pack , function(data){
            alert("row modify:" + data );
        });
    }


   //undelivered
   function undelivered(){
        wechat.undelivered( function(obj){
             for (var i=0 ; i< obj.data.length ; i++){
                 console.log(  obj );
             }
        });
   }


   //openrooms
   function openrooms(){
        //action: "open"|"close"
        var pack = { channel:"s002@s001", action:"open" };
        wechat.openrooms( pack );
   }

   //closerooms
   function closerooms(){
        //action: "open"|"close"
        var pack = { channel:"s002@s001", action:"close" };
        wechat.openrooms( pack , function(data){
            console.log( data );
        });
   }

   //getOpenRooms
   function getOpenRooms(){
      var pack = { channel:"s002@s001" , from: "s002" };
      wechat.getOpenRooms( pack , function(obj){
          console.log(obj);
          for (var i=0 ; i< obj.data.length ; i++){
            console.log( obj.data[i].sid );
            console.log( obj.data[i].starttime );
            console.log( obj.data[i].endtime );
          }
      });
   }

   //crudNews
   function crudNews(){
        //insert
        var mydata = [ { title:"mytitle0", content:"mycontent0" , created_time:"1478486744549"},
                       { title:"mytitle1", content:"mycontent1" , created_time:"1478486744555"}];
        var pack = { action:"insert" ,data: mydata};
        wechat.crudNews( pack , function(){
            console.log("success");
        });


        //query
        var pack = { action:"query", offset:0 , limit:10 };
        wechat.crudNews(pack , function(obj){
            console.log( obj );
        });
   }


   //crudTsFlag
   function crudTsFlag(){
        //update|insert
        var pack = { action:"update" ,flag:"news" , ts:"1234567890123"};
        wechat.crudTsFlag( pack , function(obj){
            console.log("ok");
        });

        //query
        var pack = { action:"query",flag:"news"};
        wechat.crudTsFlag(pack , function(obj){
            console.log( obj );
        });
   }

   //resetdb
   function resetdb(){
        wechat.resetdb(function(){
            console.log("error");
        });
   }

   //onlines
   function getOnLineUsers(){
       var users = [] ;
       var user00 = { sid: "s001"};
       users.push( user00);

       var user01 = { sid: "s002"};
       users.push( user01) ;

       var pack = { data: users };

       wechat.getOnLineUsers( pack , function(obj){
            console.log( pack  );
       });
   }


   //recive invited
   function wechatOnInviteRecived( obj ){
        console.log( "wechatInvite");
        for (var i=0 ; i< obj.data.length ; i++){
            var xsid = obj.data[i].sid;
            var xtid = obj.data[i].tid;
            var xcustom_name = obj.data[i].custom_name;
            var xcontact_id = obj.data[i].contact_id;
            alert( "Invite " + xsid );

            // answer yes
            //subscirbe
            var newchann = wechat.getInviteChann( xsid, xtid);
            var channMsg = { channel: newchann };
            wechat.subscribe( channMsg );

            var mobj = { action:"insert" , m_id: xsid , custom_name: xcustom_name  , contact_id: xcontact_id };
            console.log( mobj );
            //reigiter(jobj , errorcallback)
            wechat.register( mobj , function(){
                alert("error");
            });
        }


       //register***************************************************************************************
       //var mobj = { action:"insert" , m_id: xsid , custom_name: xcustom_name  , contact_id: xcontact_id };
       //console.log( mobj );
       //reigiter(jobj , errorcallback)
       //wechat.register( mobj , function(){
       //     alert("error");
       //});

   }


</script>

</body>
</html>
